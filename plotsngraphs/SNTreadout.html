<!DOCTYPE html>
<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src = "https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.12.1/math.js"></script>
<script>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>
<div id = "sample" style = "display:none;">4.760848119189811
4.860561416760776
4.977227572637895
4.7867671896756185
4.8531754912620615
4.857601127452502
4.839977354474846
4.9212679741183125
4.860619686096795
4.919600120709402
4.850572022602599
4.809622248087243
4.859488412164976
5.001681410977447
4.897158586565833
4.965212851078245
4.961598136996148
5.0419855112986625
4.942354004234196
4.977283519803555
5.025339476134014
4.95142854501225
5.171497456875507
5.130561069199667
5.19232981305132
5.182754035468786
5.19492224526679
5.05847524258037
5.34185120923374
5.443989206200891
5.273031765689734
5.429706489499166
5.414488672118299
5.275119681195764
5.420751096642141
5.512722497045079
5.4758848382527665
5.522054103144774
5.496138886604314
5.6781928320617885
5.639714397907476
5.74917206768391
5.628264915819817
5.897514686727956
5.80500433719069
5.682298614943646
5.7781246934285235
5.921153587365611
5.811579395554526
5.8940330621684724
6.141633455187073
6.027775475936561
6.147786312607178
6.053278977975357
5.997414626907011
6.031009281327208
6.171630697117227
6.317608973165338
6.323023988256295
6.353420209289723
6.484880320294093
6.458655012674767
6.4498309510885825
6.543212626822381
6.644450628165562
6.453353938992745
6.676956093740646
6.7223760314788965
6.705105186521848
6.775736358777327
6.682437161358097
6.743299049445952
6.736851423698171
6.762856039878807
6.8141862782019835
6.964084837585844
7.177338364429547
7.125393805792189
7.050868636469453
6.990805031400477
7.045338310703745
7.184637938385177
7.212190623907586
7.196165465834105
7.310550003182121
7.252899022827544
7.4564699541744694
7.344821772954572
7.6007094593550555
7.5204780885263265
7.464001358045128
7.639260080359716
7.5278594136161106
7.692930633105613
7.604559784254832
7.537483639381439
7.887753951513557
7.6778574406488875
7.645291787370795
7.92760740751341
7.855730459566026
7.915550310960805
8.043732484050016
8.211231764925785
7.958352831169143
8.040032672676132
8.10189541554531
8.262529523074225
8.260668862681554
8.219093693387876
8.29533026305369
8.314777674279439
8.327732469513846
8.472283987611922
8.452185757873982
8.406161359451428
8.686975392031888
8.623893558498153
8.603721411642097
8.71125632473855
8.75901167880661
8.64555020613781
8.831782622050401
8.900427030650922
8.846092499128677
8.863182193492344
8.885277456741106
8.868617398021042
9.065240131532526
9.125719234737229
9.15792830522389
9.059040383575951
9.249203818640721
9.257360477028135
9.14868946539215
9.288665993781208
9.361642534076607
9.298470344217739
9.47009115477909
9.417153488652975
9.485273067573704
9.45557454366914
9.428532453330519
9.570732701923925
9.52190757164009
9.70183487228175
9.756626979716401
9.636343961555214
9.787758718023312
9.899970015544925
9.852832770275114
9.790037783752481
9.727189425297475
9.677558826050635
9.624622775004077
9.671861423900012
9.483408850060925
9.624985134900506
9.62961725622928
9.50360628917195
9.365013822717163
9.48086742754936
9.332283082613401
9.351881487275852
9.158666604334798
9.280719910616526
9.358988675382163
9.173937685772783
9.13254973201432
9.127646714634457
9.1054190555837
8.95977821467711
8.968155283593461
8.906472213443903
8.720802988615072
8.887985295597575
8.729728566663457
8.918076165459755
8.804293967006554
8.726536580148105
8.82582368429017
8.690396046386613
8.61301642396197
8.714241745244982
8.619654926041049
8.636194411919922
8.531322900596283
8.429358491358585
8.48717216893137
8.268129650110877
8.303130314736654
8.274966954775541
8.178346788768403
8.143743844599518
8.065544096304274
8.249288706898243
8.159084464519166
7.949169201105453
7.988506045329778
7.967588788734275
8.000875387112032
7.829637276113792
7.957790268124746
7.779200777853262
7.613618162872846
7.659622927053135
7.682169150993949
7.576651832678053
7.6302836560573475
7.449135381111933
7.523256562575302
7.536256326129735
7.375030864625152
7.491245161624886
7.374368217961461
7.42340896752353
7.3396239098016185
7.258481843468755
7.235855808822729
7.104982112417878
7.31000425154517
7.157621143003182
7.06877525830307
7.037574724663452
6.974842046012552
7.032487447095804
6.754949740520153
6.799563868770544
6.75095850398903
6.813580638474732
6.691688274617779
6.646929294013586
6.770587475470214
6.544290941315599
6.586914922086263
6.554797483361508
6.52794771245017
6.571274602727046
6.525411303361982
6.370237167123962
6.25526904686578
6.440576570204536
6.2625371505116405
6.260148393017821
6.0827204705875
6.156852885336075
6.186952447718598
6.159906188589417
6.1170626135782245
6.1383270703445305
5.999602756635217
5.964277307534324
5.927465735175495
5.966439143491917
5.856789581438832
5.706079273201507
5.840412242494152
5.805952351706199
5.6674056681243945
5.80582606296657
5.566137847319778
5.650958888711125
5.658826880801691
5.389186495212798
5.538986905058763
5.491505149753742
5.290823886939795
5.41044251725171
5.355356067560367
5.444635057425465
5.408096126533971
5.368924835885841
5.26894449951951
5.159728284870424
5.177381016552875
5.236467299124285
5.062702945184798
5.318064732746963
5.04572390974512
5.088142127984186
5.026216369367809
5.01643144845818
4.983569007977638
4.972385482303533
5.07593509216991
4.8452983568435535
4.9260235679728455
5.033591962386881
4.928703989681441
4.8646052203508665
4.871570931555432
4.957415310106968
4.767949257996913
4.835627005382456
4.908046537470397
4.722971423620194
4.91001367256109
4.8956814131680595
4.901219330689994
4.904568946777367
4.952501308809228
4.6712195621212675
4.77248248935545
4.758082166409394
4.8113486316778
4.779968163658699
4.759460034617748
4.776303257207961
4.8823735866861
4.7990682952228045
4.767307363277265
4.809287852230682
4.77887586508826
4.833541731795345
4.7814699042392474
4.903680654338935
4.950351055108572
4.941304877749097
5.095543708606881
4.9228525791528766
4.972247718562689
5.249427054345194
5.072009465144685
5.143683604481663
5.226880041041418
4.9826414422229695
5.135238640579409
5.273178278492583
5.145582752357857
5.131308018609116
5.480046593936404
5.259333094647333
5.443115753888399
5.473678642452158
5.410234800228752
5.528179556774571
5.637264310422896
5.390521873765965
5.519199073633682
5.429879140569589
5.510203563085015
5.632894080531736
5.652875097236162
5.67859557665226
5.682086357133192
5.759824056776635
5.790287725420611
5.8069219703564405
5.895238969013562
6.056806801611859
5.818820957644551
6.005604489403595
5.991345865996347
6.024404249464865
6.048999048391263
6.117906348966445
6.178923627893116
6.368340844715047
6.1522099597495306
6.319742568211414
6.217298749545236
6.282756944883104
6.37466728134507
6.33122175393126
6.481706021950827
6.460961194197745
6.59028254692438
6.590249195970488
6.689758606206128
6.570244236676598
6.67547017735075
6.802473972651871
6.680208773896647
6.7549728829165225
6.759242034810288
6.792907489619899
6.922202820011536
7.014766548387563
7.090768497570313
6.985269651401296
6.985367841915217
7.110035122001591
7.038901343640163
7.39896051425147
7.152503670734558
7.39128576264472
7.145822184206917
7.269190878900506
7.264858111614024
7.450382888889454
7.387950923868765
7.567284377018332
7.582602064311118
7.419374358981054
7.5961929631600915
7.716610534691035
7.616510305855174
7.651855654787288
7.7311427185574395
7.618595314817796
7.9442749666992825
7.78410241249382
7.925115338965532
7.933735282213783
7.9073320142433765
7.941217876385098
7.9626948911520685
8.094262021324493
8.164303188778304
8.199847550001008
8.064271009931806
8.263184042239107
8.207951036361354
8.47389559741171
8.348346709787407
8.32455399050705
8.512605657945029
8.65549545203747
8.543570341056848
8.520278989003314
8.646031407118995
8.778977832634903
8.626679901700156
8.843305570812056
8.769614673764073
8.68939032858769
8.790107916738608
8.82377668423705
8.687728803574686
8.884530213981357
9.03531124910332
9.118772867967142
9.091221418334593
9.038620708374788
9.106617254963501
9.079448505197574
9.20982268268835
9.249856613211108
9.266712170628947
9.263451784035865
9.225713536904044
9.457457691874367
9.549676885548758
9.438691971052098
9.615312414973499
9.747826331630165
9.708618112727187
9.651054979566906
9.667703115996511
9.708897826376468
9.744068336850132
9.826776265011986
9.924187635797033
9.781508247514765
9.699254724210851
9.66411348485233
9.59208856534901
9.748333225227512
9.719712490382893
9.591791016764427
9.506476977456245
9.524926026053217
9.304786300201012
9.374398906479668
9.409863659217141
9.169194118833412
9.361058191814939
9.270903464684082
9.212240462520887
9.238596012338588
9.166269369681878
9.119761943344576
9.129580872067576
8.97527171528148
8.995339091143567
8.893232228657466
8.870755315420395
8.914182644175606
8.87071886073769
8.83043004871406
8.67943585006322
8.69865155224329
8.605904763963906
8.598078979299192
8.701293445551713
8.771708742710349
8.598944612674623
8.453915597768761
8.419269601851395
8.287731752840669
8.332242482042291
8.315514551384044
8.31972441279204
8.297527514808541
8.134845700609958
8.166124607575075
8.208990588594324
8.108134538666764
8.03492219562805
8.01228783586211
8.031979078200951
8.00098869128429
7.984558435899484
7.837312380812063
7.720466686073493
7.844708630540598
7.667747737149101
7.632767401346979
7.836100329956608
7.717935526881238
7.673343149785073
7.589904822696687
7.518292641940007
7.473089527280791
7.420182795520543
7.484602888993763
7.4142130895261875
7.423482753904949
7.279551956375073
7.199846607388881
7.183067548712292
7.053768388945787
7.101307674734035
7.164734528514106
6.969402088158275
6.817586795666192
6.985827564976411
6.869516445752635
6.95427383322286
6.679943908817873
6.64805534192132
6.751089539989548
6.8535311027668415
6.913187133147279
6.697156044101378
6.6527576684659095
6.556645159115584
6.560076648327831
6.6561485448206525
6.491455856254163
6.483522736226925
6.278741827822926
6.315746958014197
6.2804284783927615
6.266332759472274
6.377964707944956
6.247992752101901
6.277674427048893
6.222399885972415
6.079136276420108
6.123221731976694
6.016322477772498
5.91298848794023
5.960097730921532
5.975872991610854
5.78774220913407
5.950303134521371
5.914764270647069
5.719427061452244
5.609028937201455
5.676340099511389
5.722687591435565
5.714043307723567
5.769921294560177
5.55478095264509
5.653856735739841
5.358420519436653
5.370691512524674
5.524280755316056
5.455923360819202
5.260853209599267
5.264529854280111
5.2855334713585
5.290879228479182
5.384213045675083
5.249954702774318
5.207722529843949
5.176891037273925
5.060903626992507
5.219665460849486
5.182451492463642
4.938290498026943
5.058808629112973
5.2994820533614915
5.029390961777711
5.107933946058478
5.046513147238949
4.794942634430895
4.885789290052773
4.853459331595839
4.919352349721355
4.924693732881747
4.906843339329622
4.862672376954952
5.026241106815498
4.882222469133155
5.025205590318576
4.719181180438319
4.772653746267941
4.99785320957224</div>
</head>
<body>
    <table id = "inputs">
        <tr><td>upper trigger threshold:</td><td><input id = "thresholdin" value = "9.0" onchange = "updateplot();"></input></td></tr> 
        <tr><td>lower trigger threshold:</td><td><input id = "thresholdin2" value = "8.0" onchange = "updateplot();"></input></td></tr> 

        <tr><td>T guess:</td><td><input id = "Tguessin" value = "20" onchange = "updateplot();"></input></td></tr> 
        <tr><td>T_N guess:</td><td><input id = "TNguessin" value = "100" onchange = "updateplot();"></input></td></tr> 
        <tr><td>G guess:</td><td><input id = "Gguessin" value = "0.04" onchange = "updateplot();"></input></td></tr> 

        
    </table>
    <textarea id = "dataIN"></textarea>
    <textarea id = "svgOUT"></textarea>
    <canvas id = "plot1"></canvas>
    <div id = "chiout"></div>
    <button id = "fittButton">FIT</button>
<script>
q_e = 1.6022e-19;//coulombs
k_b = 1.38065e-23;// J/k
EK = q_e/(2*k_b);//5802 kelvins per volt
chisquared = 0;

document.getElementById("dataIN").value = document.getElementById("sample").innerHTML;
    
updateplot();
document.getElementById("fittButton").onclick = function(){

    for(var fitcount = 0;fitcount < 10;fitcount++){
    
    Ttemp = parseFloat(document.getElementById("Tguessin").value);
    Gtemp = parseFloat(document.getElementById("Gguessin").value);
    TNtemp = parseFloat(document.getElementById("TNguessin").value);
    Tguess2 = Ttemp + gauss(0.1*Ttemp);
    Gguess2 = Gtemp + gauss(0.1*Gtemp);
    TNguess2 = TNtemp + gauss(0.1*TNtemp);

    document.getElementById("Tguessin").value = Tguess2;
    document.getElementById("TNguessin").value = TNguess2;
    document.getElementById("Gguessin").value = Gguess2;

    chisquaredbefore = parseFloat(document.getElementById("chiout").innerHTML);
    updateplot();
    chisquaredafter = parseFloat(document.getElementById("chiout").innerHTML);
    if(chisquaredafter < chisquaredbefore){
        console.log("less");
        document.getElementById("Tguessin").value = Tguess2;
        document.getElementById("Gguessin").value = Gguess2;
        document.getElementById("TNguessin").value = TNguess2;

    }
    else{
        console.log("greater");
        document.getElementById("Tguessin").value = Ttemp;
        document.getElementById("TNguessin").value = TNtemp;
        document.getElementById("Gguessin").value = Gtemp;
        updateplot();
    }
    }
}
function updateplot(){

    rawdata = document.getElementById("dataIN").value;
    dataArray = rawdata.split("\n");
    n = dataArray.length;
    plot1 = document.getElementById("plot1");
    plot1.width = n;
    h = 400;
    plot1.height = h;
    w = n;
    ctx = plot1.getContext("2d");
    ctx.lineWidth = 2;
    ctx.clearRect(0,0,w,h);

    threshold = document.getElementById("thresholdin").value;
    ctx.strokeStyle="green";
    ctx.beginPath();
    y = h - h*threshold/10;
    ctx.setLineDash([3,3,3,3]);
    ctx.moveTo(0,y);
    ctx.lineTo(w,y);
    ctx.stroke();
    ctx.closePath();

    threshold2 = document.getElementById("thresholdin2").value;
    ctx.strokeStyle="green";
    ctx.beginPath();
    y = h - h*threshold2/10;
    ctx.setLineDash([10,3,3,3]);
    ctx.moveTo(0,y);
    ctx.lineTo(w,y);
    ctx.stroke();
    ctx.closePath();
    ctx.setLineDash([]);


    ctx.strokeStyle="green";
    for(var index = 0;index < n;index++){
        y = h - h*dataArray[index]/10;
        //ctx.lineTo(index,y);
        ctx.beginPath();
		ctx.arc(index, y,.25, 0, 2 * Math.PI);
		ctx.closePath();
		ctx.stroke();
		ctx.fill();
    }

    windowstart = 0;
    windowend = w;
    index0 = 0;
    index1 = 0;
    index2 = 0;
    index3 = 0;
    for(var index = 1;index < n;index++){
        if(dataArray[index] < threshold && dataArray[index - 1] > threshold){
            index0 = index;
        }
        if(dataArray[index] < threshold2 && dataArray[index - 1] > threshold2 && index0 > 0){
            index1 = index;
            break;
        }

    }
    for(var index = index1;index < n;index++){
        if(dataArray[index] > threshold2 && dataArray[index-1] < threshold2){
            index2 = index;
        }
        if(dataArray[index] > threshold && dataArray[index-1] < threshold && index2 > 0){
            index3 = index;
            break;
        }
    }
    windowstart = index0;
    windowend = index3;

    ctx.strokeStyle="red";
    ctx.beginPath();
    y = h - h*dataArray[windowstart]/10;
    ctx.moveTo(windowstart,y);
    for(var index = windowstart + 1;index < windowend;index++){
        y = h - h*dataArray[index]/10;
        ctx.lineTo(index,y);
    }
    ctx.stroke();
    ctx.closePath();

    
    Tguess = parseFloat(document.getElementById("Tguessin").value);
    Gguess = parseFloat(document.getElementById("Gguessin").value);
    TNguess = parseFloat(document.getElementById("TNguessin").value);
    Pguess = [];
    for(var index = 0;index < dataArray.length;index++){
        Pguess.push(P(Gguess,TNguess,Tguess,n/2,index));//temperature is in pixels, one point per pixel, convert to K with pixels/V then V/K
    } 

    ctx.strokeStyle="green";
    ctx.beginPath();
    y = h - h*Pguess[windowstart]/10;
    ctx.moveTo(windowstart,y);
    chisquared = 0;
    for(var index = windowstart + 1;index < windowend;index++){
        Pderp = Pguess[index];
        chisquared += (dataArray[index] - Pguess[index])*(dataArray[index] - Pguess[index]);
        y = h - h*Pderp/10;
        ctx.lineTo(index,y);
    }
    ctx.stroke();
    ctx.closePath();
    document.getElementById("chiout").innerHTML = chisquared;

    for(var index = windowstart + 1;index < windowend;index++){
        y = 0.9*h - h*(Pguess[index] - dataArray[index])/10;        
        ctx.beginPath();
		ctx.arc(index, y,.25, 0, 2 * Math.PI);
		ctx.closePath();
		ctx.stroke();
		ctx.fill();
    }


}


function Pzero(G,T,x0,x){
    return G*(T*xcothx((x - x0)/T) - T);
}

function P(G,TN,T,x0,x){
    return G*(TN + T*xcothx((x - x0)/T));
}

function xcothx(xin){
    if(xin != 0){
        yout = xin/Math.tanh(xin);
    }
    else{
        yout = 1;
    }
    return yout;
}
function gauss(sigma){
/*  https://en.wikipedia.org/wiki/Box–Muller_transform  */
    u1 = Math.random();
    u2 = Math.random();
    z1 = Math.sqrt(-2.0*Math.log(u1))*Math.sin(2*Math.PI*u2);
    z0 = Math.sqrt(-2.0*Math.log(u1))*Math.cos(2*Math.PI*u2);
	return z0*sigma;
}

</script>
<style>
    html{
        background-color:yellow;
    }
    #plot1{
        position:absolute;
        left:400px;
        top:100px;
        background-color:black;
        border:solid;
        border-color:black;
    }
    #inputs{
        border:solid;
        border-radius:15px;
        padding:15px 15px 15px 15px;
        background-color:greenyellow;
        position:absolute;
        left:10px;
        top:100px;
    }
    #dataIN{
        position:absolute;
        left:10px;
        bottom:10px;
        width:300px;
        height:50px;
    }
    #svgOUT{
        position:absolute;
        right:10px;
        bottom:10px;
        width:300px;
        height:50px;
    }
    #chiout{
        position:absolute;
        bottom:10px;
        left:50%;
        width:200px;
    }
</style>   
</body>
</html>